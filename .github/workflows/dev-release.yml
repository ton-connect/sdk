name: Dev Release

on:
  push:
    branches:
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dev-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read .nvmrc
        run: echo "NVMRC=$(cat .nvmrc)" >> $GITHUB_ENV

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NVMRC }}'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Build
        uses: ./.github/actions/build

      - name: Run tests
        run: pnpm test
        continue-on-error: false

      - name: Extract versions and create tags
        id: version
        run: |
          # Get short commit hash
          SHORT_HASH=$(git rev-parse --short HEAD)
          
          # Get current date for unique version suffix
          DATE_SUFFIX=$(date +%Y%m%d%H%M%S)
          
          # Read versions from each package and create dev versions
          echo "Creating dev versions for packages..."
          
          # Array to store all tags
          TAGS=""
          
          # Process each package
          for pkg_json in packages/*/package.json; do
            if [ -f "$pkg_json" ]; then
              PKG_NAME=$(node -p "require('./$pkg_json').name")
              BASE_VERSION=$(node -p "require('./$pkg_json').version")
              
              CLEAN_VERSION=$(echo $BASE_VERSION | sed 's/-.*$//')
              DEV_VERSION=$(node -e "
                const version = '$CLEAN_VERSION';
                const parts = version.split('.');
                if (parts.length >= 2) {
                  const major = parseInt(parts[0]) || 0;
                  const minor = parseInt(parts[1]) || 0;
                  const patch = parts.length > 2 ? parseInt(parts[2]) || 0 : 0;
                  const newMinor = minor + 1;
                  console.log(major + '.' + newMinor + '.' + patch + '-dev.' + '$DATE_SUFFIX' + '.' + '$SHORT_HASH');
                } else {
                  console.log(version + '-dev.' + '$DATE_SUFFIX' + '.' + '$SHORT_HASH');
                }
              ")
              
              echo "Package: $PKG_NAME"
              echo "Base version: $BASE_VERSION"
              echo "Dev version: $DEV_VERSION"
              
              # Update package.json with dev version
              node -e "
                const fs = require('fs');
                const pkg = require('./$pkg_json');
                pkg.version = '$DEV_VERSION';
                fs.writeFileSync('$pkg_json', JSON.stringify(pkg, null, 2) + '\n');
              "
              
              # Add tag to list
              TAG="${PKG_NAME}@${DEV_VERSION}"
              TAGS="${TAGS}${TAG}\n"
              
              # Create git tag
              git tag "$TAG"
            fi
          done
          
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo -e "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT

      - name: Push tags
        run: |
          git push origin --tags

      - name: Publish to npm
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "::error::NPM_TOKEN is not set. Add it in Settings â†’ Secrets and variables â†’ Actions to publish to npm."
            exit 1
          fi
          
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          
          # Publish each package with dev tag
          for pkg_dir in packages/*; do
            if [ -d "$pkg_dir" ] && [ -f "$pkg_dir/package.json" ]; then
              echo "Publishing $pkg_dir..."
              cd "$pkg_dir"
              
              # Publish with dev tag (not latest)
              npm publish --access public --tag dev --provenance
              
              cd ../..
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create Release Notes
        run: |
          echo "# Dev Release $(date +%Y-%m-%d)" > release_notes.md
          echo "" >> release_notes.md
          echo "## Commit: ${{ steps.version.outputs.short_hash }}" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Published packages:" >> release_notes.md
          echo "" >> release_notes.md
          echo "${{ steps.version.outputs.tags }}" >> release_notes.md
          echo "" >> release_notes.md
          echo "Install with:" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "npm install <package-name>@dev" >> release_notes.md
          echo '```' >> release_notes.md
          
          cat release_notes.md

      - name: Comment on commits
        uses: actions/github-script@v7
        with:
          script: |
            const tags = `${{ steps.version.outputs.tags }}`.trim();
            const shortHash = `${{ steps.version.outputs.short_hash }}`;
            
            const body = `ðŸš€ **Dev Release Published**\n\n` +
              `Published packages:\n\n${tags.split('\n').map(t => `- \`${t}\``).join('\n')}\n\n` +
              `Install with: \`npm install <package-name>@dev\``;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: body
            });

