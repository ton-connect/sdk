name: Release

on:
  push:
    branches:
      - main
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Read .nvmrc
        run: echo "NVMRC=$(cat .nvmrc)" >> $GITHUB_ENV

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '${{ env.NVMRC }}'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Build
        uses: ./.github/actions/build

      - name: Run tests
        run: pnpm test

      # â”€â”€ main: compare each package with npm, block major bumps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check for version changes (main)
        id: version_check
        if: github.ref == 'refs/heads/main'
        run: |
          node << 'EOF'
          const fs = require('fs');
          const { execSync } = require('child_process');

          function getMajor(v) {
            const m = /^(\d+)/.exec(String(v));
            return m ? parseInt(m[1], 10) : 0;
          }

          const changedPackages = [];
          let hasBeta = false;
          let releaseTag = '';

          const pkgPaths = [];
          for (const dir of fs.readdirSync('packages')) {
            const p = `packages/${dir}/package.json`;
            if (fs.existsSync(p)) pkgPaths.push(p);
          }

          for (const pkgJson of pkgPaths) {
            const pkg = JSON.parse(fs.readFileSync(pkgJson, 'utf-8'));
            const { name, version: current, private: isPrivate } = pkg;

            if (isPrivate) {
              console.log(`  ${name}: private, skip`);
              continue;
            }

            let npmVersion = '';
            try {
              npmVersion = execSync(`npm view ${name} version`, {
                encoding: 'utf-8',
                stdio: ['pipe', 'pipe', 'ignore']
              }).trim();
            } catch (_) {}

            if (current === npmVersion) {
              console.log(`  ${name}: ${current} (same as npm, skip)`);
              continue;
            }

            if (npmVersion) {
              if (getMajor(current) > getMajor(npmVersion)) {
                console.error(
                  `::error::Major version bump is not allowed in CI. ` +
                  `Release majors manually. Package: ${name}, npm: ${npmVersion}, current: ${current}`
                );
                process.exit(1);
              }
            }

            console.log(`  ${name}: ${npmVersion || '(new)'} -> ${current}`);
            changedPackages.push(`${name}@${current}`);
            if (current.toLowerCase().includes('beta')) hasBeta = true;
            if (!releaseTag) releaseTag = `v${current}`;
          }

          const out = process.env.GITHUB_OUTPUT;
          if (changedPackages.length === 0) {
            console.log('All package versions match npm. Skipping release.');
            fs.appendFileSync(out, `should_release=false\n`);
            process.exit(0);
          }

          console.log('Changed packages:', changedPackages.join(', '));
          fs.appendFileSync(out, `should_release=true\n`);
          fs.appendFileSync(out, `has_beta=${hasBeta}\n`);
          fs.appendFileSync(out, `release_tag=${releaseTag}\n`);
          fs.appendFileSync(out, `changed_packages<<EOF\n${changedPackages.join('\n')}\nEOF\n`);
          fs.appendFileSync(out, `tags<<EOF\n${changedPackages.join('\n')}\nEOF\n`);
          EOF

      # â”€â”€ develop: compute dev versions (next minor + dev.DATE.HASH) â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract versions and create tags (develop)
        id: version
        if: github.ref == 'refs/heads/develop'
        run: |
          SHORT_HASH=$(git rev-parse --short HEAD)
          DATE_SUFFIX=$(date +%Y%m%d%H%M%S)
          echo "Creating dev versions for packages..."
          TAGS=""
          for pkg_json in packages/*/package.json; do
            [ -f "$pkg_json" ] || continue

            PRIVATE=$(node -p "require('./$pkg_json').private || false")
            if [ "$PRIVATE" = "true" ]; then
              echo "Skipping private package: $pkg_json"
              continue
            fi

            PKG_NAME=$(node -p "require('./$pkg_json').name")
            BASE_VERSION=$(node -p "require('./$pkg_json').version")
            # Strip any pre-release suffix to get clean semver base
            CLEAN_VERSION=$(echo "$BASE_VERSION" | sed 's/-.*$//')
            DEV_VERSION=$(node -e "
              const [major, minor = 0, patch = 0] = '$CLEAN_VERSION'.split('.').map(Number);
              console.log(major + '.' + (minor + 1) + '.' + patch + '-dev.' + '$DATE_SUFFIX' + '.' + '$SHORT_HASH');
            ")
            echo "  $PKG_NAME: $BASE_VERSION -> $DEV_VERSION"

            # Write dev version into package.json for publish
            node -e "
              const fs = require('fs');
              const pkg = JSON.parse(fs.readFileSync('$pkg_json', 'utf-8'));
              pkg.version = '$DEV_VERSION';
              fs.writeFileSync('$pkg_json', JSON.stringify(pkg, null, 2) + '\n');
            "

            TAG="${PKG_NAME}@${DEV_VERSION}"
            TAGS="${TAGS}${TAG}\n"
            git tag "$TAG"
          done
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          printf "%b" "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT

      # â”€â”€ main: create git tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create git tags (main)
        if: github.ref == 'refs/heads/main' && steps.version_check.outputs.should_release == 'true'
        run: |
          while IFS= read -r tag; do
            [ -n "$tag" ] && git tag "$tag"
          done <<< "${{ steps.version_check.outputs.tags }}"
          RELEASE_TAG="${{ steps.version_check.outputs.release_tag }}"
          [ -n "$RELEASE_TAG" ] && git tag "$RELEASE_TAG"

      # â”€â”€ push tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Push tags (main)
        if: github.ref == 'refs/heads/main' && steps.version_check.outputs.should_release == 'true'
        run: git push origin --tags

      - name: Push tags (develop)
        if: github.ref == 'refs/heads/develop'
        run: git push origin --tags

      # â”€â”€ main: publish to npm (beta / latest) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Publish to npm (main)
        if: github.ref == 'refs/heads/main' && steps.version_check.outputs.should_release == 'true'
        run: |
          NPM_TAG=$( [ "${{ steps.version_check.outputs.has_beta }}" = "true" ] && echo "beta" || echo "latest" )
          echo "Publishing with npm tag: $NPM_TAG"
          while IFS= read -r pkg_version; do
            [ -z "$pkg_version" ] && continue
            PKG_NAME="${pkg_version%@*}"
            echo "Publishing $PKG_NAME ($NPM_TAG)..."
            pnpm publish \
              --filter="$PKG_NAME" \
              --access=public \
              --publish-branch=main \
              --tag="$NPM_TAG" \
              --provenance \
              --verbose
          done <<< "${{ steps.version_check.outputs.changed_packages }}"

      # â”€â”€ develop: publish to npm (dev) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Publish to npm (develop)
        if: github.ref == 'refs/heads/develop'
        run: |
          echo "Publishing with npm tag: dev"
          for pkg_json in packages/*/package.json; do
            [ -f "$pkg_json" ] || continue
            PRIVATE=$(node -p "require('./$pkg_json').private || false")
            [ "$PRIVATE" = "true" ] && continue
            PKG_NAME=$(node -p "require('./$pkg_json').name")
            echo "Publishing $PKG_NAME..."
            pnpm publish \
              --filter="$PKG_NAME" \
              --access=public \
              --publish-branch=develop \
              --tag=dev \
              --no-git-checks \
              --provenance \
              --verbose
          done

      # â”€â”€ main: GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create GitHub Release (main)
        if: github.ref == 'refs/heads/main' && steps.version_check.outputs.should_release == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changedPackages = `${{ steps.version_check.outputs.changed_packages }}`.trim();
            const releaseTag = `${{ steps.version_check.outputs.release_tag }}`;
            const hasBeta = `${{ steps.version_check.outputs.has_beta }}` === 'true';
            const npmTag = hasBeta ? 'beta' : 'latest';
            const body =
              `## Released packages\n\n` +
              changedPackages.split('\n').filter(Boolean).map(p => `- \`${p}\``).join('\n') +
              `\n\nInstall with: \`npm install <package-name>@${npmTag}\``;
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: releaseTag,
              name: `Release ${releaseTag}`,
              body,
              prerelease: hasBeta
            });

      # â”€â”€ main: merge main back into develop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Merge main into develop
        if: github.ref == 'refs/heads/main' && steps.version_check.outputs.should_release == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');

            execSync('git fetch origin', { stdio: 'inherit' });

            // Ensure local develop tracks origin/develop
            try {
              execSync('git checkout -B develop origin/develop', { stdio: 'inherit' });
            } catch (_) {
              execSync('git checkout -b develop', { stdio: 'inherit' });
            }

            try {
              execSync('git merge origin/main --no-edit', { stdio: 'inherit' });
              execSync('git push origin develop', { stdio: 'inherit' });
              console.log('âœ… Merged main into develop successfully.');
            } catch (mergeErr) {
              console.log('âš ï¸ Merge conflict detected â€” aborting merge and opening a PR instead.');
              try { execSync('git merge --abort', { stdio: 'inherit' }); } catch (_) {}

              // Reset to origin/develop to have a clean base for the PR
              execSync('git checkout -B develop origin/develop', { stdio: 'inherit' });

              const branchName = `ci/merge-main-into-develop-${context.sha.slice(0, 7)}`;
              execSync(`git checkout -b ${branchName}`, { stdio: 'inherit' });
              execSync('git merge origin/main --no-edit --strategy-option theirs', { stdio: 'inherit' });
              execSync(`git push origin ${branchName}`, { stdio: 'inherit' });

              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `chore: merge main into develop after release`,
                body: `Automatic back-merge of \`main\` into \`develop\` after release.\n\nAuto-merge had conflicts â€” please review and merge.`,
                head: branchName,
                base: 'develop'
              });
              console.log(`PR created: ${pr.data.html_url}`);
            }

      # â”€â”€ develop: annotate commit with published packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment on commit (develop)
        if: github.ref == 'refs/heads/develop'
        uses: actions/github-script@v7
        with:
          script: |
            const tags = `${{ steps.version.outputs.tags }}`.trim();
            const shortHash = `${{ steps.version.outputs.short_hash }}`;
            if (!tags) return;
            const body =
              `ðŸš€ **Dev Release Published** (commit \`${shortHash}\`)\n\n` +
              `Published packages:\n` +
              tags.split('\n').filter(Boolean).map(t => `- \`${t}\``).join('\n') +
              `\n\nInstall with: \`npm install <package-name>@dev\``;
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body
            });
